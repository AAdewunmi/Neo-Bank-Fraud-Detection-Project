name: NeoBank CI

on:
  push:
    branches: [ "main", "week1/**" ]
  pull_request:
  workflow_dispatch:

jobs:
  unit:
    name: unit (fast)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            requirements/base.txt
            requirements/dev.txt

      - name: Install dependencies (base + dev)
        run: |
          python -m pip install --upgrade pip

          if [ -f requirements/base.txt ]; then
            python -m pip install -r requirements/base.txt
          else
            python -m pip install -r requirements.txt
          fi

          if [ -f requirements/dev.txt ]; then
            python -m pip install -r requirements/dev.txt
          fi

      - name: Lint
        run: |
          flake8 .

      - name: Tests (coverage gate)
        run: |
          coverage run -m pytest -q
          coverage report

  ml_smoke:
    name: ml smoke (opt-in)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            requirements/base.txt
            requirements/dev.txt
            requirements/ml.txt

      - name: Cache Hugging Face models
        uses: actions/cache@v4
        with:
          path: .cache/huggingface
          key: hf-${{ runner.os }}-${{ hashFiles('requirements/ml.txt') }}

      - name: Install dependencies (base + dev + ml)
        env:
          HF_HOME: .cache/huggingface
        run: |
          python -m pip install --upgrade pip

          if [ -f requirements/base.txt ]; then
            python -m pip install -r requirements/base.txt
          else
            python -m pip install -r requirements.txt
          fi

          if [ -f requirements/dev.txt ]; then
            python -m pip install -r requirements/dev.txt
          fi

          python -m pip install -r requirements/ml.txt

      - name: Run ML tests only
        env:
          HF_HOME: .cache/huggingface
          RUN_SLOW_ML_TESTS: "1"
        run: |
          pytest -q -m "ml"
          echo "ML smoke tests completed."