{% extends "customer/base.html" %}

{% block content %}
<div class="row g-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body p-4">
        <div class="row align-items-center g-3">
          <div class="col-lg-8">
            <h1 class="display-6 fw-semibold mb-2">Your activity at a glance</h1>
            <p class="text-muted mb-0">
              Clear, plain-language insights into your recent activity and risk status.
              Details are limited to protect your privacy.
            </p>
          </div>
          <div class="col-lg-4">
            <div class="soft-panel rounded-4 p-3">
              <div class="fw-semibold mb-1">Fraud status</div>
              <div class="d-flex align-items-center justify-content-between">
                <span class="badge text-bg-warning">Reviewing</span>
                <span class="text-muted small">No action required</span>
              </div>
              <div class="text-muted small mt-2">
                We will contact you if we need more information.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-7">
    <div class="card shadow-sm h-100">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="fw-semibold">Recent transactions</div>
          {% if has_rows %}
            <button class="btn btn-sm btn-outline-secondary" type="button">Download statement CSV</button>
          {% endif %}
        </div>
        {% if warning_message %}
          <div class="alert alert-warning py-2 mb-3 small">{{ warning_message }}</div>
        {% endif %}
        {% if has_rows %}
          {% if summary.has_data %}
            <div class="border rounded-4 bg-white p-3 mb-3">
              <div class="row g-3 align-items-center">
                <div class="col-md-4">
                  <div class="text-muted small">Month-to-date spend</div>
                  <div class="h4 mb-1">${{ summary.mtd_total }}</div>
                  <div class="text-muted small">Across visible transactions</div>
                </div>
                <div class="col-md-8">
                  <div class="text-muted small mb-2">Top categories</div>
                  <div class="row g-2">
                    {% for item in summary.categories %}
                      <div class="col-sm-6">
                        <div class="d-flex justify-content-between">
                          <span class="small">{{ item.name }}</span>
                          <span class="small text-muted">${{ item.total }}</span>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
          {% endif %}
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-3">
              <thead>
                <tr class="text-muted small">
                  <th scope="col">Timestamp</th>
                  <th scope="col">Merchant</th>
                  <th scope="col">Description</th>
                  <th scope="col">Category</th>
                  <th scope="col" class="text-end">Amount</th>
                  <th scope="col">Report</th>
                </tr>
              </thead>
              <tbody>
                {% for row in rows %}
                  <tr data-row-id="{{ row.row_id }}">
                    <td class="text-muted small">{{ row.timestamp }}</td>
                    <td>{{ row.merchant }}</td>
                    <td class="text-muted small">{{ row.description }}</td>
                    <td class="text-muted small">{{ row.category }}</td>
                    <td class="text-end">{{ row.amount }}</td>
                    <td>
                      {% if flags and row.row_id in flags %}
                        <span class="badge text-bg-warning">Flagged</span>
                      {% else %}
                        <form method="post" action="{% url 'customer:flag' %}" class="d-flex gap-2 align-items-center">
                          {% csrf_token %}
                          <input type="hidden" name="row_id" value="{{ row.row_id }}">
                          <input
                            class="form-control form-control-sm"
                            type="text"
                            name="reason"
                            maxlength="200"
                            placeholder="Reason (optional)"
                            aria-label="Reason for reporting transaction"
                          >
                          <button class="btn btn-sm btn-outline-primary" type="submit">Not mine</button>
                        </form>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-muted small">Showing {{ rows_shown }} of {{ total_count }} transactions</span>
            <button class="btn btn-sm btn-outline-primary" type="button">Report a transaction</button>
          </div>
        {% else %}
          <div class="border rounded-4 bg-white p-4 text-center">
            <div class="fw-semibold mb-2">No transactions yet</div>
            <p class="text-muted small mb-0">
              When we receive activity for your account, it will appear here in a safe, read-only view.
            </p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    {% if has_rows %}
      <div class="card shadow-sm mb-4">
        <div class="card-body p-4">
          <div class="fw-semibold mb-3">Spend by category (month-to-date)</div>
          <div class="mb-3">
            <div class="d-flex justify-content-between">
              <span class="text-muted small">Groceries</span>
              <span class="text-muted small">$412</span>
            </div>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar" role="progressbar" style="width: 55%;"></div>
            </div>
          </div>
          <div class="mb-3">
            <div class="d-flex justify-content-between">
              <span class="text-muted small">Transport</span>
              <span class="text-muted small">$210</span>
            </div>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar bg-info" role="progressbar" style="width: 28%;"></div>
            </div>
          </div>
          <div class="mb-3">
            <div class="d-flex justify-content-between">
              <span class="text-muted small">Dining</span>
              <span class="text-muted small">$180</span>
            </div>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar bg-success" role="progressbar" style="width: 24%;"></div>
            </div>
          </div>
          <div>
            <div class="d-flex justify-content-between">
              <span class="text-muted small">Travel</span>
              <span class="text-muted small">$146</span>
            </div>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar bg-warning" role="progressbar" style="width: 18%;"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body p-4">
          <div class="fw-semibold mb-2">Need to report a transaction?</div>
          <p class="text-muted small mb-3">
            Flag a purchase as "not mine" and add a short note. We will review it and
            update your status if action is needed.
          </p>
          <div class="d-flex gap-2">
            <button class="btn btn-primary" type="button">Report a transaction</button>
            <button class="btn btn-outline-secondary" type="button">View status</button>
          </div>
        </div>
      </div>
    {% else %}
      <div class="card shadow-sm">
        <div class="card-body p-4 text-center">
          <div class="fw-semibold mb-2">Insights will appear here</div>
          <p class="text-muted small mb-0">
            We will summarise your spend and categories once transactions are available.
          </p>
        </div>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
